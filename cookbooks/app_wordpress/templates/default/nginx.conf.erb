<% if @params[:aliases] -%>
server {
  listen 80;
  server_name <% @params[:aliases].each do |a| -%><%= " #{a}" %><% end -%>;

  # Canonical host, <%= @params[:fqdn] %>
  # The "right" Nginx way - http://wiki.nginx.org/Pitfalls#Taxing_Rewrites
  rewrite ^ http://<%= @params[:fqdn] %>$request_uri? permanent;
}
<% end -%>

server {
  listen 80;
  server_name <%= @params[:fqdn] %>;

  access_log <%= node[:nginx][:log_dir] %>/<%= @params[:fqdn] %>-access.log;
  error_log <%= node[:nginx][:log_dir] %>/<%= @params[:fqdn] %>-error.log;

  root <%= node[:nginx][:content_dir] %>/<%= @params[:fqdn] %>/htdocs/;

  # Display a maintenance page if it exists.
  try_files /system/maintenance.html @proxy;

  try_files $uri $uri/ /index.php?q=$uri;

  location ~ .php$ {
    fastcgi_pass   unix:/var/run/php5-fpm.sock;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;
    include        fastcgi_params;

    fastcgi_param SCRIPT_NAME $fastcgi_script_name;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_param DOCUMENT_URI $document_uri;
    fastcgi_param DOCUMENT_ROOT $document_root;
    fastcgi_param REMOTE_ADDR $remote_addr;
    fastcgi_param REMOTE_PORT $remote_port;
    fastcgi_param SERVER_ADDR $server_addr;
    fastcgi_param SERVER_PORT $server_port;
    fastcgi_param SERVER_NAME $server_name;
    fastcgi_param QUERY_STRING $query_string;
    fastcgi_param REQUEST_METHOD $request_method;
    fastcgi_param CONTENT_TYPE $content_type;
    fastcgi_param CONTENT_LENGTH $content_length;
  }
}